#include <span class="string">"grace2html.h"</span>
#include &lt;grace/filesystem.h&gt;
#include &lt;grace/strutil.h&gt;

APPOBJECT(grace2htmlApp);

//  =========================================================================
/// Main method.
//  =========================================================================
<span class="keyword">int</span> grace2htmlApp::main (<span class="keyword">void</span>)
{
    <span class="keyword">string</span> code;
    code = fs.load (argv[<span class="string">"*"</span>][0]);
    bool indouble = false;
    bool insingle = false;
    
    <span class="keyword">value</span> kwdb =
        $(<span class="string">"if"</span>, 1) -&gt;
        $(<span class="string">"while"</span>, 1) -&gt;
        $(<span class="string">"do"</span>, 1) -&gt;
        $(<span class="string">"select"</span>, 1) -&gt;
        $(<span class="string">"case"</span>, 1) -&gt;
        $(<span class="string">"default"</span>, 1) -&gt;
        $(<span class="string">"char"</span>, 1) -&gt;
        $(<span class="string">"short"</span>, 1) -&gt;
        $(<span class="string">"int"</span>, 1) -&gt;
        $(<span class="string">"void"</span>, 1) -&gt;
        $(<span class="string">"double"</span>, 1) -&gt;
        $(<span class="string">"float"</span>, 1) -&gt;
        $(<span class="string">"unsigned"</span>, 1) -&gt;
        $(<span class="string">"long"</span>, 1) -&gt;
        $(<span class="string">"const"</span>, 1) -&gt;
        $(<span class="string">"class"</span>, 1) -&gt;
        $(<span class="string">"public"</span>, 1) -&gt;
        $(<span class="string">"private"</span>, 1) -&gt;
        $(<span class="string">"protected"</span>, 1) -&gt;
        $(<span class="string">"new"</span>, 1) -&gt;
        $(<span class="string">"extern"</span>, 1) -&gt;
        $(<span class="string">"value"</span>, 1) -&gt;
        $(<span class="string">"statstring"</span>, 1) -&gt;
        $(<span class="string">"string"</span>, 1) -&gt;
        $(<span class="string">"returnclass"</span>, 1) -&gt;
        $(<span class="string">"retain"</span>) -&gt;
        $(<span class="string">"foreach"</span>, 1) -&gt;
        $(<span class="string">"sharedsection"</span>, 1) -&gt;
        $(<span class="string">"exclusivesection"</span>, 1) -&gt;
        $(<span class="string">"caseselector"</span>, 1) -&gt;
        $(<span class="string">"incaseof"</span>, 1) -&gt;
        $(<span class="string">"defaultcase"</span>, 1);
    
    <span class="keyword">value</span> lines = strutil::split (code, <span class="string">'\n'</span>);
    
    <span class="keyword">foreach</span> (line, lines)
    {
        <span class="keyword">string</span> l = line;
        <span class="keyword">string</span> out;
        
        for (<span class="keyword">int</span> i=0; i&lt;l.strlen(); ++i)
        {
            <span class="keyword">if</span> (l[i] == <span class="string">'\t'</span>)
            {
                <span class="keyword">do</span>
                {
                    out.strcat (<span class="string">' '</span>);
                } <span class="keyword">while</span> (out.strlen() &amp; 3);
            }
            else <span class="keyword">if</span> (l[i] == <span class="string">'&lt;'</span>)
            {
                out.strcat (<span class="string">"&amp;lt;"</span>);
            }
            else <span class="keyword">if</span> (l[i] == <span class="string">'&gt;'</span>)
            {
                out.strcat (<span class="string">"&amp;gt;"</span>);
            }
            else <span class="keyword">if</span> (l[i] == <span class="string">'&amp;'</span>)
            {
                out.strcat (<span class="string">"&amp;amp;"</span>);
            }
            else
            {
                out.strcat (l[i]);
            }
        }
        
        l = out;
        out.crop ();
        
        for (<span class="keyword">int</span> i=0; i&lt;l.strlen(); ++i)
        {
            <span class="keyword">if</span> (l[i] == <span class="string">'\\'</span>)
            {
                out.strcat (l[i++]);
                out.strcat (l[i]);
            }
            else
            {
                <span class="keyword">if</span> ((l[i] == <span class="string">'\"'</span>) &amp;&amp; (! insingle))
                {
                    indouble = !indouble;
                    <span class="keyword">if</span> (indouble)
                    {
                        out.strcat (<span class="string">"&lt;span class=\"string\"&gt;\""</span>);
                    }
                    else
                    {
                        out.strcat (<span class="string">"\"&lt;/span&gt;"</span>);
                    }
                }
                else <span class="keyword">if</span> ((l[i] == <span class="string">'\''</span>) &amp;&amp; (! indouble))
                {
                    insingle = !insingle;
                    <span class="keyword">if</span> (insingle)
                    {
                        out.strcat (<span class="string">"&lt;span class=\"string\"&gt;'"</span>);
                    }
                    else
                    {
                        out.strcat (<span class="string">"'&lt;/span&gt;"</span>);
                    }
                }
                else <span class="keyword">if</span> ( (! insingle) &amp;&amp; (! indouble) )
                {
                    <span class="keyword">char</span> oc = i ? l[i-1] : 0;
                    <span class="keyword">if</span> ((! isalpha (oc)) &amp;&amp; (! isdigit (oc)) &amp;&amp;
                        (oc != <span class="string">'_'</span>) &amp;&amp; (oc != <span class="string">'$'</span>))
                    {
                        <span class="keyword">int</span> j;
                        <span class="keyword">string</span> kwmatch = l.mid (i, 15);
                        for (j=0; j&lt;kwmatch.strlen(); ++j)
                        {
                            <span class="keyword">char</span> c = kwmatch[j];
                            <span class="keyword">if</span> ((! isalpha (c)) &amp;&amp;
                                (! isdigit (c)) &amp;&amp;
                                (c != <span class="string">'$'</span>) &amp;&amp; (c != <span class="string">'_'</span>) &amp;&amp;
                                (c != <span class="string">'%'</span>)) break;
                        }
                        <span class="keyword">if</span> (j&lt;15) kwmatch.crop (j);
                        
                        <span class="keyword">if</span> (kwdb.exists (kwmatch))
                        {
                            out.strcat (<span class="string">"&lt;span class=\"keyword\"&gt;"</span>
                                        <span class="string">"%s&lt;/span&gt;"</span> %format (kwmatch));
                            i += kwmatch.strlen() -1;
                        }
                        else
                        {
                            out.strcat (l[i]);
                        }
                    }
                    else
                    {
                        out.strcat (l[i]);
                    }
                }
                else
                {
                    out.strcat (l[i]);
                }
            }
        }
        
        fout.writeln (out);
    }
    
    return 0;
}


